<nav class="site-nav">
  <ul>
    {{ $current := . }}
    {{ range .Site.Sections }}
        {{ if eq $current.Section .Section }}
            {{ template "section-tree-nav" (dict "page" . "current" $current) }} 
        {{ end }}
    {{ end }}
  </ul>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Get all section titles
      const sectionTitles = document.querySelectorAll('.section-title');
      
      // Add click event listener to each section title
      sectionTitles.forEach(title => {
        const parentLi = title.closest('li');
        const sectionPages = parentLi.querySelector('.section-pages');
        const chevron = title.querySelector('.chevron');
        
        // Set initial chevron state based on whether the section is collapsed
        if (sectionPages.classList.contains('collapsed') && chevron) {
          chevron.classList.add('rotated');
        }
        
        // Add click event to toggle visibility
        title.addEventListener('click', function(e) {
          // Check if the click was on the chevron
          if (e.target.classList.contains('chevron') || e.target.closest('.chevron')) {
            // Prevent default link behavior only when clicking on chevron
            e.preventDefault();

            // Toggle collapsed class
            sectionPages.classList.toggle('collapsed');

            // Toggle chevron rotation if it exists
            if (chevron) {
              chevron.classList.toggle('rotated');
            }
          }
          // If click was not on chevron, default link behavior will navigate to the page
        });
      });
    });
  </script>
</nav>

{{ define "section-tree-nav" }}
    {{ $access := partial "page-allowed.html" .page }}
    {{ if $access.allowed }}
        <li>
            <a
                href="{{ .page.RelPermalink }}"
                class="
                  {{ if and $access.development (not $access.excluded) }}disabled{{ end }}
                  {{ if $access.excluded }}excluded{{ end }}
                  {{ if and $access.variant $access.excluded }}conflict{{ end }}
                  {{ if .page.IsSection }}section-title{{ else }}page-link{{ end }}
                  {{ if eq .page.RelPermalink .current.RelPermalink }}active{{ end }}
                "
                >
                  <div class="content">
                    {{ if .page.IsSection }}
                        {{ $isActive := or (eq .page.RelPermalink .current.RelPermalink) (in .current.RelPermalink .page.RelPermalink) }}
                        <img src="/images/chevron-down.svg" class="chevron{{ if not $isActive }} rotated{{ end }}" />
                    {{ end }}
                    <div style="flex: 1">{{ partial "page-title.html" .page }}</div>
                    {{ if and $access.variant $access.excluded }}
                    <sl-tooltip content="This page is both included and excluded from this variant.">
                      <sl-icon name="exclamation-diamond"></sl-icon>
                    </sl-tooltip>
                    {{ end }}
                  </div>
                </a
            >
            {{ if .page.IsSection }}
                {{ $isActive := or (eq .page.RelPermalink .current.RelPermalink) (in .current.RelPermalink .page.RelPermalink) }}
                <ul class="section-pages{{ if not $isActive }} collapsed{{ end }}">
                    {{ range .page.Pages.ByWeight }}
                        {{ template "section-tree-nav" (dict "page" . "current" $.current) }}
                    {{ end }}
                </ul>
            {{ end }}
        </li>
    {{ end }}
{{ end }}
